# Requirements:
# dna_pair

{% set strelka_version = '2.9.2' %}
{% set dna_pair_name = dna_pair.replace(',', '-') %}

- id: Strelka2_{{ dna_pair_name }}
  help: |
    Launch Strelka on a dna-pair for a single interval.

    Bam file paths are assumed to be in <sample_name>/<sample_name>.bam

    Important! Strelk2 currently has problems processing genomes with a large 
    number of contigs. The workaround involves limiting the calling to major 
    contigs (1-22,X,Y,MT for example) to avoid slowdown issues.
    
    See user guide here:
    https://github.com/Illumina/strelka/blob/master/docs/userGuide/README.md

  methods: Somatic variants were called for {{ dna_pair_name }} with Strelka2 v{{ strelka_version }}
  cmd: sbatch_wait -c12 -N Strelka2_{{ dna_pair_name }}
  stdin: |
    #!/bin/bash
    set -eu
    module load strelka/{{ strelka_version }}

    REF="{{ ref.genome_index }}"
    DNAPAIR_LINE="{{ dna_pair }}"
    PAIR_NAME="${DNAPAIR_LINE//,/-}"
    PAIR=(${DNAPAIR_LINE//,/ })
    
    NORMAL_NAME=${PAIR[0]}
    NORMAL_BAM="${NORMAL_NAME}/${NORMAL_NAME}.bam"

    TUMOR_NAME=${PAIR[1]}
    TUMOR_BAM="${TUMOR_NAME}/${TUMOR_NAME}.bam"

    ${STRELKA_INSTALL_PATH}/bin/configureStrelkaSomaticWorkflow.py \
      --normalBam ${NORMAL_BAM} \
      --tumorBam ${TUMOR_BAM} \
      --ref  \
      --runDir ${PAIR_NAME}/${PAIR_NAME}_strelka_somatic/

    # execution on a single local machine with 12 parallel jobs
    ${PAIR_NAME}/${PAIR_NAME}_strelka_somatic/runWorkflow.py -m local -j 12

