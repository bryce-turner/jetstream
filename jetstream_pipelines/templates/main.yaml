
# Setup the run
- id: inform_start
  help: This task demonstrates how scripts can be embedded in a workflow
  cmd: python
  stdin: |
    import os
    print(os.listdir())


# DNA Alignment steps
{% for sample in project.list_samples() if sample.assay in ["Exome", "Genome"] %}
- id: alignment_{{ sample.sample_name }}
  after: inform_start
  cmd: >
    jetstream_pipelines dna_align.yaml --sample '{{ sample | tojson }}'

- id: merge_bams_{{ sample.sample_name }}
  after: alignment_{{ sample.sample_name }}
  cmd: >
    jetstream_pipelines merge_bams.yaml --sample '{{ sample | tojson }}'

{% endfor %}


# RNA Alignment steps
# TODO


# Stuff between alignment and variant calling
- id: alignment_is_done
  help: This is just a symbolic task that represents the point at which
    all of the alignment steps are done. It's completely unnecessary, but
    demonstrates how to specify "after" for multiple items. 
  after: 
    {% for sample in project.list_samples() %}
    - merge_bams_{{ sample.sample_name }} 
    {% endfor %}
  cmd: echo


# Somatic variant calling steps
{% for dna_pair in project.config.run_parameters.dnapair %}
- id: Mutect2_{{ dna_pair }}
  after: alignment_is_done
  cmd: jetstream_pipelines mutect.yaml --dna_pair "{{ dna_pair }}"

{% endfor %}


# Finalize the run
- id: inform_complete
  after: alignment_is_done
  cmd: bash
  stdin: |
    #!/bin/bash
    echo Project all done $(date) > finished.txt

