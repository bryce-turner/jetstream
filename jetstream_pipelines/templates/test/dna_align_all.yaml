{% for data in project.config.data -%}{% if data.type == 'FQ' %}

- id: bwa_mem_{{ loop.index }}
  cmd: sbatch_wait -c8
  stdin: |
    #!/bin/bash
    set -eu
    module load bwa/0.7.12 samtools/1.4.1

    REF="{{ project.config.reference.genome_index }}"
    READ_GROUP=$(echo -e "@RG\tID:{{ data.read_group.ID}}\t\
    PL:{{ data.read_group.PL }}\t")
    OUTPATH="{{ data.sample_name }}.bwa.bam"
    R1FASTQ="{{ data.path }}"
    R2FASTQ="${R1FASTQ/R1_001/R2_001}"

    bwa mem \
      -M \
      -t8 \
      -R ${READ_GROUP} \
      ${REF} \
      ${R1FASTQ} \
      ${R2FASTQ} |\
    samtools sort -O BAM -o ${OUTPATH} -


- id: base_recalibration_{{ loop.index }}
  after: bwa_mem_{{ loop.index }}
  cmd: sbatch_wait -c8
  stdin: |
    #!/bin/bash
    set -eu
    module load gatk/4.0.1.2

    REF="{{ project.config.reference.genome_index }}"
    KNOWN_SITES="{{ project.config.reference.known_sites }}"
    IN_BAM="{{ data.sample_name }}.bwa.bam"
    OUT_PREFIX="{{ data.sample_name }}"

    gatk BaseRecalibrator \
        --reference ${REF} \
        --known-sites ${KNOWN_SITES} \
        --input ${IN_BAM} \
        --output ${OUT_PREFIX}.recal_data.table

    gatk ApplyBQSR \
       --reference ${REF} \
       --input ${IN_BAM} \
       --bqsr-recal-file ${OUT_PREFIX}.recal_data.table \
       -O {OUT_PREFIX}.bam


{% endif %}{% endfor %}
